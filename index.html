<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Independence Day ID Card Generator</title>
<style>
  :root{
    --w: 360px;   /* card width */
    --h: 550px;   /* card height */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:#f4f6f8; font-family:system-ui, Arial, sans-serif; text-align:center;
  }
  h1{
    margin:18px 12px; color:#0b6b2b; font-weight:800; letter-spacing:.3px
  }

  .card-wrap{
    width:var(--w); margin:18px auto; position:relative;
  }

  .card{
    position:relative; width:var(--w); height:var(--h);
    border-radius:14px; overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.25);
    user-select:none;
    background:#fff;
  }

  .card .bg{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0;
    pointer-events:none;
  }

  .photo-frame{
    position:absolute; z-index:2;
    left:50%; transform:translateX(-50%);
    top:240px;
    width:132px; height:132px;
    border-radius:16px; overflow:hidden;
  }
  .photo-frame img{width:100%; height:100%; object-fit:cover}

  .text{
    position:absolute; left:50%; transform:translateX(-50%); width:92%; text-align:center;
    z-index:2; color:#0a33ff; font-weight:900; text-shadow:0 1px 2px rgba(255,255,255,.9);
    letter-spacing:.3px;
  }
  #name-field{ bottom:120px; font-size:22px }
  #id-field  { bottom:90px;  font-size:20px }

  .panel-top,
  .panel-bottom{
    width:var(--w); margin:10px auto;
    display:flex; flex-direction:column;
    gap:12px;
    align-items:stretch;
  }

  .input-box input[type="text"]{
    width:100%; padding:12px 14px;
    border:1px solid #cfd8dc; border-radius:10px;
    font-size:15px;
    outline:none; transition:.25s;
  }
  .input-box input[type="text"]:focus{
    border-color:#0b6b2b; box-shadow:0 0 0 2px rgba(11,107,43,0.2);
  }

  .file-label{
    display:block; padding:12px 14px;
    background:#fff; border:1px solid #cfd8dc;
    border-radius:10px; cursor:pointer;
    font-size:15px; text-align:left;
    transition:.25s;
  }
  .file-label:hover{border-color:#0b6b2b}
  .file-name{
    font-size:13px; color:#444; margin-top:4px;
    text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #imgInput{display:none}

  .btn{
    padding:12px 18px; border:0; border-radius:12px; font-weight:700; cursor:pointer;
    background:#0e7a34; color:#fff; box-shadow:0 3px 10px rgba(0,0,0,.2);
    font-size:15px; width:100%;
    transition:.3s;
  }
  .btn:hover{filter:brightness(1.1)}
  .btn.secondary{background:#0e4ec2}
  .btn:disabled{opacity:.55; cursor:not-allowed}
</style>
</head>
<body>

<h1>Independence Day ID Card Generator</h1>

<!-- Top panel (inputs + generate) -->
<div class="panel-top">
  <div class="input-box">
    <input type="text" id="nameInput" placeholder="Enter your name">
  </div>
  <div class="input-box">
    <label class="file-label" for="imgInput">Choose Photo</label>
    <input type="file" id="imgInput" accept="image/*">
    <div id="fileName" class="file-name"></div>
  </div>
  <button class="btn" onclick="generateIDCard()">Generate</button>
</div>

<!-- Card preview -->
<div class="card-wrap">
  <div class="card" id="id-card">
    <img id="bg" class="bg" src="card.jpg" alt="Template" crossorigin="anonymous" />
    <div class="photo-frame"><img id="profile-pic" alt=""></div>
    <div class="text" id="name-field">YOUR NAME</div>
    <div class="text" id="id-field">ID NO: XXXXX</div>
  </div>
</div>

<!-- Bottom panel (download button same size as generate) -->
<div class="panel-bottom">
  <button id="dlBtn" class="btn secondary" onclick="downloadCard()" disabled>Download</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const $ = sel => document.querySelector(sel);

  function generateRandomID(){
    return Math.floor(100000 + Math.random() * 900000);
  }

  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function waitForImage(imgEl){
    return new Promise((res, rej)=>{
      if (imgEl.complete && imgEl.naturalWidth) return res();
      imgEl.addEventListener('load', res, {once:true});
      imgEl.addEventListener('error', ()=>rej(new Error('Image failed to load: '+imgEl.src)), {once:true});
    });
  }

  $('#imgInput').addEventListener('change', e=>{
    const file = e.target.files[0];
    $('#fileName').textContent = file ? file.name : '';
    $('#dlBtn').disabled = true; // Reset download button on new file
  });

  async function generateIDCard(){
    const name = $('#nameInput').value.trim();
    const file = $('#imgInput').files[0];

    if(!name){ alert('Please enter your name'); return; }
    if(!file){ alert('Please upload an image'); return; }

    $('#name-field').textContent = name.toUpperCase();
    $('#id-field').textContent   = 'ID NO: ' + generateRandomID();

    try{
      const dataUrl = await readFileAsDataURL(file);
      $('#profile-pic').src = dataUrl;

      await Promise.all([ waitForImage($('#bg')), waitForImage($('#profile-pic')) ]);
      $('#dlBtn').disabled = false;
    }catch(e){
      console.error(e);
      alert('Image failed to load. Please try another image or reload the page.');
      $('#dlBtn').disabled = true;
    }
  }
async function downloadCard() {
  const card = document.getElementById("id-card");

  html2canvas(card, {
    useCORS: true,
    scale: 3,
    backgroundColor: null,
    width: card.offsetWidth,
    height: card.offsetHeight,
    x: 0,
    y: 0,
    scrollX: 0,
    scrollY: 0
  }).then(canvas => {
    const ctx = canvas.getContext("2d");
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imgData.data;

    let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;

    // Scan for non-transparent pixels
    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const idx = (y * canvas.width + x) * 4;
        const alpha = pixels[idx + 3];
        if (alpha > 0) {
          if (x < minX) minX = x;
          if (x > maxX) maxX = x;
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        }
      }
    }

    // Handle edge cases: completely blank card
    if (maxX <= minX || maxY <= minY) {
      alert("Card appears to be blank. Please generate before downloading.");
      return;
    }

    // Create cropped canvas
    const cropWidth = maxX - minX + 1;
    const cropHeight = maxY - minY + 1;
    const croppedCanvas = document.createElement("canvas");
    croppedCanvas.width = cropWidth;
    croppedCanvas.height = cropHeight;
    const croppedCtx = croppedCanvas.getContext("2d");
    croppedCtx.putImageData(ctx.getImageData(minX, minY, cropWidth, cropHeight), 0, 0);

    // Trigger download
    const link = document.createElement("a");
    link.download = "id-card.png";
    link.href = croppedCanvas.toDataURL("image/png");
    link.click();
  });
}
</script>
</body>
</html>
